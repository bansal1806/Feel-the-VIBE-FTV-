generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  // Shadow database is optional - Prisma will use the main database if shadow is not available
}

enum RoomType {
  STUDY
  EVENT
  SOCIAL
}

enum EventCategory {
  SOCIAL
  ACADEMIC
  CAREER
  WELLNESS
  SPORTS
  OTHER
}

enum ConversationType {
  DIRECT
  ROOM
}

enum SwipeTargetType {
  USER
  ROOM
  EVENT
}

enum SwipeDirection {
  LIKE
  PASS
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  BLOCKED
}

enum EventAttendeeStatus {
  GOING
  INTERESTED
  DECLINED
}

enum NotificationType {
  MATCH
  ROOM_ACTIVITY
  EVENT_UPDATE
  TIME_CAPSULE
  SYSTEM
}

model User {
  @@map("users")
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  alias         String    @unique
  name          String?
  avatarUrl     String?
  bio           String?
  major         String?
  year          String?
  interests     String[]  @default([])
  skillCreds    Int       @default(0)
  onboardingAt  DateTime?
  profileCompletedAt DateTime?
  dualIdentityMode  Boolean   @default(true)
  discoverable       Boolean   @default(true)
  recruiterOptIn     Boolean   @default(false)
  shareAnalytics     Boolean   @default(false)
  campusId       String?
  headline       String?
  pronouns       String?
  hometown       String?
  lookingFor     String[]  @default([])
  intents        String[]  @default([])
  seeking        String[]  @default([])
  latitude       Float?
  longitude      Float?
  lastActiveAt   DateTime?
  profileVisibility String?    @default("campus")
  allowMessagesFrom  String?   @default("campus")
  createdRoomsCount  Int       @default(0)
  joinedRoomsCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  rooms         RoomMember[]
  conversations ConversationParticipant[]
  timecapsules  Timecapsule[]      @relation("CreatorCapsules")
  createdRooms  Room[]             @relation("RoomCreator")
  roomMessages  RoomMessage[]      @relation("RoomMessageSender")
  messages      Message[]          @relation("MessageSender")
  campus        Campus?            @relation(fields: [campusId], references: [id])
  swipes        Swipe[]
  sentConnections    Connection[]  @relation("UserConnections")
  receivedConnections Connection[] @relation("PeerConnections")
  eventRsvps    EventAttendee[]
  notifications Notification[]
  createdEvents Event[]            @relation("EventCreator")
  timecapsuleContributions TimecapsuleContribution[]
}

model Room {
  @@map("rooms")
  id           String    @id @default(cuid())
  name         String
  description  String?
  location     String
  latitude     Float
  longitude    Float
  type         RoomType
  active       Boolean   @default(true)
  expiresAt    DateTime
  creatorId    String
  campusId     String?
  inviteCode   String?   @unique
  maxCapacity  Int?
  access       String    @default("public")
  tags         String[]  @default([])
  lastPingAt   DateTime? 
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  creator      User       @relation("RoomCreator", fields: [creatorId], references: [id])
  members      RoomMember[]
  messages     RoomMessage[]
  campus       Campus?    @relation(fields: [campusId], references: [id])
  conversation Conversation? @relation("RoomConversation")
  events       Event[]    @relation("RoomEvent")
}

model RoomMember {
  @@map("room_members")
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  room      Room     @relation(fields: [roomId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model RoomMessage {
  @@map("room_messages")
  id        String   @id @default(cuid())
  roomId    String
  senderId  String
  content   String
  mediaUrl  String?
  replyToId String?
  reactions Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  room      Room     @relation(fields: [roomId], references: [id])
  sender    User     @relation("RoomMessageSender", fields: [senderId], references: [id])
  replyTo   RoomMessage? @relation("RoomMessageReplies", fields: [replyToId], references: [id])
  replies   RoomMessage[] @relation("RoomMessageReplies")
}

model Conversation {
  @@map("conversations")
  id          String                        @id @default(cuid())
  type        ConversationType
  roomId      String?                       @unique
  createdAt   DateTime                      @default(now())
  updatedAt   DateTime                      @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
  room         Room?                        @relation("RoomConversation", fields: [roomId], references: [id])
  connection   Connection?
}

model ConversationParticipant {
  @@map("conversation_participants")
  id             String        @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime      @default(now())
  lastReadAt     DateTime?

  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  @@map("messages")
  id             String        @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  mediaUrl       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  replyToId      String?
  reactions      Json?

  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  sender         User          @relation("MessageSender", fields: [senderId], references: [id])
  replyTo        Message?      @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]     @relation("MessageReplies")
}

model Timecapsule {
  @@map("timecapsules")
  id          String   @id @default(cuid())
  creatorId   String
  campusId    String?
  title       String
  description String?
  mediaUrl    String?
  unlockAt    DateTime
  audience    String
  coverImage  String?
  tags        String[]  @default([])
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User     @relation("CreatorCapsules", fields: [creatorId], references: [id])
  campus      Campus?  @relation(fields: [campusId], references: [id])
  contributions TimecapsuleContribution[]
}

model TimecapsuleContribution {
  @@map("timecapsule_contributions")
  id            String   @id @default(cuid())
  capsuleId     String
  contributorId String
  message       String?
  mediaUrl      String?
  createdAt     DateTime @default(now())

  capsule       Timecapsule @relation(fields: [capsuleId], references: [id])
  contributor   User        @relation(fields: [contributorId], references: [id])

  @@unique([capsuleId, contributorId])
}

model Swipe {
  @@map("swipes")
  id         String          @id @default(cuid())
  userId     String
  targetType SwipeTargetType
  targetId   String
  direction  SwipeDirection
  createdAt  DateTime        @default(now())

  user       User            @relation(fields: [userId], references: [id])

  @@index([userId, targetType, targetId])
  @@unique([userId, targetType, targetId])
}

model Connection {
  @@map("connections")
  id               String            @id @default(cuid())
  userId           String
  peerId           String
  status           ConnectionStatus  @default(PENDING)
  conversationId   String?           @unique
  trustLevel       Int               @default(0) // 0-100, per-connection trust progression
  lastInteractionAt DateTime         @default(now())
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  user         User          @relation("UserConnections", fields: [userId], references: [id])
  peer         User          @relation("PeerConnections", fields: [peerId], references: [id])
  conversation Conversation? @relation(fields: [conversationId], references: [id])

  @@unique([userId, peerId])
  @@index([peerId, userId])
}

model Event {
  @@map("events")
  id           String        @id @default(cuid())
  campusId     String?
  roomId       String?
  createdById  String?
  title        String
  description  String?
  category     EventCategory @default(OTHER)
  location     String
  latitude     Float?
  longitude    Float?
  coverImage   String?
  hostName     String?
  tags         String[]      @default([])
  startTime    DateTime
  endTime      DateTime?
  rsvpCount    Int           @default(0)
  isFeatured   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  campus       Campus?       @relation(fields: [campusId], references: [id])
  room         Room?         @relation("RoomEvent", fields: [roomId], references: [id])
  createdBy    User?         @relation("EventCreator", fields: [createdById], references: [id])
  attendees    EventAttendee[]

  @@index([campusId, startTime])
  @@index([isFeatured])
}

model EventAttendee {
  @@map("event_attendees")
  id        String              @id @default(cuid())
  eventId   String
  userId    String
  status    EventAttendeeStatus @default(GOING)
  rsvpAt    DateTime            @default(now())

  event     Event               @relation(fields: [eventId], references: [id])
  user      User                @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
}

model Campus {
  @@map("campuses")
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  city      String?
  state     String?
  country   String?
  timezone  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  rooms     Room[]
  events    Event[]
  capsules  Timecapsule[]
}

model Notification {
  @@map("notifications")
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  payload   Json
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

